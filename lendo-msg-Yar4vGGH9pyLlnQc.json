{"updatedAt":"2025-10-07T18:12:31.315Z","createdAt":"2025-10-07T15:41:22.599Z","id":"Yar4vGGH9pyLlnQc","name":"Lendo msg","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours","hoursInterval":3}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,80],"id":"28a02735-2fc1-4b8d-9e22-9de06b96bde0","name":"Schedule Trigger"},{"parameters":{"jsCode":"// INPUT: itens do n8n no formato padr칚o, ex. { json: { id, contato, msgs, datetime, lido } }\n// OUTPUT: um item por contato -> { contato, total, itens: [...], primeiros_e_ultimos: {...} }\n\nconst rows = $input.all().map(i => i.json);\n\n// agrupa\nconst groups = new Map();\nfor (const r of rows) {\n  const key = (r.contato ?? '').toString().trim();\n  if (!key) continue; // pula registros sem contato\n  if (!groups.has(key)) groups.set(key, []);\n  groups.get(key).push(r);\n}\n\n// opcional: ordena cada grupo por datetime asc (se existir)\nfor (const [key, arr] of groups) {\n  arr.sort((a, b) => {\n    const da = new Date(a.datetime || 0).getTime();\n    const db = new Date(b.datetime || 0).getTime();\n    return da - db;\n  });\n}\n\n// monta sa칤da (1 item por contato)\nconst out = [];\nfor (const [contato, itens] of groups) {\n  out.push({\n    json: {\n      contato,\n      total: itens.length,\n      itens,\n      // 칰teis pra debug/relat칩rios r치pidos\n      primeiros_e_ultimos: {\n        primeiro: itens[0] ?? null,\n        ultimo: itens[itens.length - 1] ?? null,\n      }\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[448,80],"id":"80e71a2d-da82-42ae-a470-25a528bc46db","name":"Separa por contato"},{"parameters":{"fieldToSplitOut":"contato","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[672,112],"id":"deb3009a-df6f-4b2c-aef1-03dc82fb4e85","name":"Split contato"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[896,80],"id":"cd0c3a7b-0934-4dd3-8810-44e96b9fa9b4","name":"Loop Over Items"},{"parameters":{"resource":"comment","commentOn":"task","id":"={{ $json.clickup_task_id }}","commentText":"=Novo retorno do notificado:\n\n{{ $('Code').item.json.mensagem_final }}","additionalFields":{}},"type":"n8n-nodes-base.clickUp","typeVersion":1,"position":[1792,0],"id":"01f3d5d8-d8ff-46f8-946d-5704979df4fa","name":"Create a comment","credentials":{"clickUpApi":{"id":"Ojf4svHZEpjVSlYw","name":"ClickUp Miqueias"}},"disabled":true},{"parameters":{"jsCode":"// Pega todos os itens de entrada (de v치rios contatos)\nconst rows = $input.all().map(i => i.json);\n\n// Agrupa por contato\nconst groups = {};\nfor (const r of rows) {\n  const key = r.contato || 'desconhecido';\n  if (!groups[key]) groups[key] = [];\n  groups[key].push(r);\n}\n\n// Monta a mensagem final de todos os contatos\nlet geral = '';\n\nfor (const [contato, msgs] of Object.entries(groups)) {\n  // ordena por data\n  msgs.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));\n\n  // limpa o contato (sem @s.whatsapp.net)\n  const contatoFmt = contato.replace('@s.whatsapp.net', '');\n\n  // t칤tulo de cada bloco\n  geral += `游녻 *Contato:* ${contatoFmt}\\n游닆 *Hist칩rico de mensagens:*\\n\\n`;\n\n  // mensagens individuais\n  for (const m of msgs) {\n    const dataFmt = new Date(m.datetime).toLocaleString('pt-BR', {\n      day: '2-digit', month: '2-digit', year: 'numeric',\n      hour: '2-digit', minute: '2-digit'\n    });\n    geral += `游뎹 ${dataFmt} - 游눫 ${m.msgs}\\n`;\n  }\n\n  // separador entre contatos\n  geral += `\\n\\n`;\n}\n\n// limpa espa칞os extras\ngeral = geral.trim();\n\nreturn [{\n  json: {\n    total_contatos: Object.keys(groups).length,\n    mensagem_final: geral\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1344,0],"id":"f366c697-7dca-4196-80bf-74966e397445","name":"Code"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM `notificacoes`\n  WHERE `contato` = '{{ $('Obtem msgs retorno').first().json.contato }}'","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[1568,0],"id":"dcfe720a-0623-41b1-9335-9195a2cf2d20","name":"Pega ID tarefa","credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"operation":"select","table":{"__rl":true,"value":"notificacao_retorno","mode":"list","cachedResultName":"notificacao_retorno"},"where":{"values":[{"column":"lido","value":"0"}]},"options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[224,80],"id":"798374c3-b7ec-4484-a6c1-0f1bfdda24f1","name":"Obtem msg nao lidas","credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM `notificacao_retorno`\n  WHERE `contato` = '{{ $json.contato }}';","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[1120,0],"id":"8eb92f0a-126d-4b08-a52e-2cdf9064670d","name":"Obtem msgs retorno","credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"assignments":{"assignments":[{"id":"258980d4-b251-444f-a8a8-d094a601808e","name":"data","value":"={{ $('Obtem msgs retorno').all() }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2080,48],"id":"471d19c8-891a-492b-94c3-a5317074cf3e","name":"Edit Fields"}],"connections":{"Schedule Trigger":{"main":[[{"node":"Obtem msg nao lidas","type":"main","index":0}]]},"Separa por contato":{"main":[[{"node":"Split contato","type":"main","index":0}]]},"Split contato":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Obtem msgs retorno","type":"main","index":0}]]},"Code":{"main":[[{"node":"Pega ID tarefa","type":"main","index":0}]]},"Create a comment":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Pega ID tarefa":{"main":[[{"node":"Create a comment","type":"main","index":0}]]},"Obtem msg nao lidas":{"main":[[{"node":"Separa por contato","type":"main","index":0}]]},"Obtem msgs retorno":{"main":[[{"node":"Code","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[21]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"d1ef9726-7dd8-40ae-a376-c520be7806cb","activeVersionId":"d1ef9726-7dd8-40ae-a376-c520be7806cb","triggerCount":1,"shared":[{"updatedAt":"2025-10-07T15:41:22.599Z","createdAt":"2025-10-07T15:41:22.599Z","role":"workflow:owner","workflowId":"Yar4vGGH9pyLlnQc","projectId":"BlSED80HESP48veq"}],"activeVersion":{"updatedAt":"2025-12-01T11:56:54.083Z","createdAt":"2025-12-01T11:56:54.083Z","versionId":"d1ef9726-7dd8-40ae-a376-c520be7806cb","workflowId":"Yar4vGGH9pyLlnQc","nodes":[{"parameters":{"rule":{"interval":[{"field":"hours","hoursInterval":3}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,80],"id":"28a02735-2fc1-4b8d-9e22-9de06b96bde0","name":"Schedule Trigger"},{"parameters":{"jsCode":"// INPUT: itens do n8n no formato padr칚o, ex. { json: { id, contato, msgs, datetime, lido } }\n// OUTPUT: um item por contato -> { contato, total, itens: [...], primeiros_e_ultimos: {...} }\n\nconst rows = $input.all().map(i => i.json);\n\n// agrupa\nconst groups = new Map();\nfor (const r of rows) {\n  const key = (r.contato ?? '').toString().trim();\n  if (!key) continue; // pula registros sem contato\n  if (!groups.has(key)) groups.set(key, []);\n  groups.get(key).push(r);\n}\n\n// opcional: ordena cada grupo por datetime asc (se existir)\nfor (const [key, arr] of groups) {\n  arr.sort((a, b) => {\n    const da = new Date(a.datetime || 0).getTime();\n    const db = new Date(b.datetime || 0).getTime();\n    return da - db;\n  });\n}\n\n// monta sa칤da (1 item por contato)\nconst out = [];\nfor (const [contato, itens] of groups) {\n  out.push({\n    json: {\n      contato,\n      total: itens.length,\n      itens,\n      // 칰teis pra debug/relat칩rios r치pidos\n      primeiros_e_ultimos: {\n        primeiro: itens[0] ?? null,\n        ultimo: itens[itens.length - 1] ?? null,\n      }\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[448,80],"id":"80e71a2d-da82-42ae-a470-25a528bc46db","name":"Separa por contato"},{"parameters":{"fieldToSplitOut":"contato","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[672,112],"id":"deb3009a-df6f-4b2c-aef1-03dc82fb4e85","name":"Split contato"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[896,80],"id":"cd0c3a7b-0934-4dd3-8810-44e96b9fa9b4","name":"Loop Over Items"},{"parameters":{"resource":"comment","commentOn":"task","id":"={{ $json.clickup_task_id }}","commentText":"=Novo retorno do notificado:\n\n{{ $('Code').item.json.mensagem_final }}","additionalFields":{}},"type":"n8n-nodes-base.clickUp","typeVersion":1,"position":[1792,0],"id":"01f3d5d8-d8ff-46f8-946d-5704979df4fa","name":"Create a comment","credentials":{"clickUpApi":{"id":"Ojf4svHZEpjVSlYw","name":"ClickUp Miqueias"}},"disabled":true},{"parameters":{"jsCode":"// Pega todos os itens de entrada (de v치rios contatos)\nconst rows = $input.all().map(i => i.json);\n\n// Agrupa por contato\nconst groups = {};\nfor (const r of rows) {\n  const key = r.contato || 'desconhecido';\n  if (!groups[key]) groups[key] = [];\n  groups[key].push(r);\n}\n\n// Monta a mensagem final de todos os contatos\nlet geral = '';\n\nfor (const [contato, msgs] of Object.entries(groups)) {\n  // ordena por data\n  msgs.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));\n\n  // limpa o contato (sem @s.whatsapp.net)\n  const contatoFmt = contato.replace('@s.whatsapp.net', '');\n\n  // t칤tulo de cada bloco\n  geral += `游녻 *Contato:* ${contatoFmt}\\n游닆 *Hist칩rico de mensagens:*\\n\\n`;\n\n  // mensagens individuais\n  for (const m of msgs) {\n    const dataFmt = new Date(m.datetime).toLocaleString('pt-BR', {\n      day: '2-digit', month: '2-digit', year: 'numeric',\n      hour: '2-digit', minute: '2-digit'\n    });\n    geral += `游뎹 ${dataFmt} - 游눫 ${m.msgs}\\n`;\n  }\n\n  // separador entre contatos\n  geral += `\\n\\n`;\n}\n\n// limpa espa칞os extras\ngeral = geral.trim();\n\nreturn [{\n  json: {\n    total_contatos: Object.keys(groups).length,\n    mensagem_final: geral\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1344,0],"id":"f366c697-7dca-4196-80bf-74966e397445","name":"Code"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM `notificacoes`\n  WHERE `contato` = '{{ $('Obtem msgs retorno').first().json.contato }}'","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[1568,0],"id":"dcfe720a-0623-41b1-9335-9195a2cf2d20","name":"Pega ID tarefa","credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"operation":"select","table":{"__rl":true,"value":"notificacao_retorno","mode":"list","cachedResultName":"notificacao_retorno"},"where":{"values":[{"column":"lido","value":"0"}]},"options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[224,80],"id":"798374c3-b7ec-4484-a6c1-0f1bfdda24f1","name":"Obtem msg nao lidas","credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM `notificacao_retorno`\n  WHERE `contato` = '{{ $json.contato }}';","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[1120,0],"id":"8eb92f0a-126d-4b08-a52e-2cdf9064670d","name":"Obtem msgs retorno","credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"assignments":{"assignments":[{"id":"258980d4-b251-444f-a8a8-d094a601808e","name":"data","value":"={{ $('Obtem msgs retorno').all() }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2080,48],"id":"471d19c8-891a-492b-94c3-a5317074cf3e","name":"Edit Fields"}],"connections":{"Schedule Trigger":{"main":[[{"node":"Obtem msg nao lidas","type":"main","index":0}]]},"Separa por contato":{"main":[[{"node":"Split contato","type":"main","index":0}]]},"Split contato":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Obtem msgs retorno","type":"main","index":0}]]},"Code":{"main":[[{"node":"Pega ID tarefa","type":"main","index":0}]]},"Create a comment":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Pega ID tarefa":{"main":[[{"node":"Create a comment","type":"main","index":0}]]},"Obtem msg nao lidas":{"main":[[{"node":"Separa por contato","type":"main","index":0}]]},"Obtem msgs retorno":{"main":[[{"node":"Code","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]}},"authors":"system migration","name":null,"description":null,"autosaved":false},"tags":[]}