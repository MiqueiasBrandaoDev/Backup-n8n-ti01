{"updatedAt":"2026-01-15T14:04:41.983Z","createdAt":"2026-01-15T14:04:41.983Z","id":"6lBo9HU83MlXLUYJ","name":"Make OpenAI Citation for File Retrieval RAG","active":false,"isArchived":false,"nodes":[{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"id":"2ba4bbc9-2dff-4b77-903a-e0fb3854523a","name":"Agregar","type":"n8n-nodes-base.aggregate","position":[-528,704],"typeVersion":1,"alwaysOutputData":true},{"parameters":{},"id":"d90920b7-6f8f-4621-922a-b0f14f42ff86","name":"Memória de Buffer em Janela","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","position":[-288,272],"typeVersion":1.3},{"parameters":{"content":"## Dentro do N8N, haverá um botão de chat para testar","height":80,"width":840,"color":3},"id":"a2e7a4cf-17d6-478e-97d5-d36c0cfca448","name":"Nota Adesiva 4","type":"n8n-nodes-base.stickyNote","position":[-1056,912],"typeVersion":1},{"parameters":{"content":"## Criar Citações OpenAI para RAG de Recuperação de Arquivos\n\n## Caso de uso\n\nNeste exemplo, garantiremos que todos os textos do assistente OpenAI busquem citações e fontes nos arquivos do vector store. Também podemos formatar a saída para Markdown ou tags HTML.\n\nIsso é necessário porque o assistente às vezes gera caracteres estranhos, e também podemos usar referências dinâmicas como citações 1, 2, 3, por exemplo.\n\n## O que este workflow faz\n\nNeste workflow, usaremos um assistente OpenAI criado dentro da interface deles, equipado com um vector store contendo alguns arquivos para recuperação.\n\nO assistente realizará a busca de arquivos dentro da infraestrutura OpenAI e retornará o conteúdo com citações.\n\n- Faremos uma requisição HTTP para recuperar todos os detalhes necessários para formatar a saída de texto.\n\n## Configuração\n\nInserir uma chave OpenAI\n\n## Como ajustar às suas necessidades\n\nNo final do workflow, temos um bloco de código que formatará a saída, e lá podemos adicionar tags Markdown para criar links. Opcionalmente, podemos transformar a formatação Markdown em HTML.\n\n\npor Davi Saranszky Mesquita\nhttps://www.linkedin.com/in/mesquitadavi/","height":720,"width":500,"color":5},"id":"f41a6592-31fb-4c6e-98c4-ba309d7bac66","name":"Nota Adesiva Principal","type":"n8n-nodes-base.stickyNote","position":[-1728,64],"typeVersion":1},{"parameters":{"options":{}},"id":"fe57d24a-0e86-417f-9030-fc4777f76287","name":"Criar um Trigger simples para ter o botão de Chat dentro do N8N","type":"@n8n/n8n-nodes-langchain.chatTrigger","position":[-1024,64],"webhookId":"8ccaa299-6f99-427b-9356-e783893a3d0c","notesInFlow":true,"typeVersion":1.1,"notes":"https://www.npmjs.com/package/@n8n/chat"},{"parameters":{"resource":"assistant","assistantId":{"__rl":true,"mode":"list","value":"asst_QAfdobVCVCMJz8LmaEC7nlId","cachedResultName":"Teste"},"options":{"preserveOriginalTools":false}},"id":"79a5e139-1d54-4435-b431-1ea6f3c78c08","name":"Assistente OpenAI com Vector Store","type":"@n8n/n8n-nodes-langchain.openAi","position":[-688,64],"typeVersion":1.7},{"parameters":{"content":"## Configuração\n\n- Configurar chave OpenAI\n\n### Nesta etapa, usaremos um assistente criado dentro da plataforma OpenAI que contém um vector store a.k.a recuperação de arquivos","width":300},"id":"d7e0e6be-0051-4819-a3a8-93489bd96cb2","name":"Nota Adesiva 1","type":"n8n-nodes-base.stickyNote","position":[-720,-128],"typeVersion":1},{"parameters":{"url":"=https://api.openai.com/v1/threads/{{ $json.threadId }}/messages","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"options":{}},"id":"8d1fed14-5a8b-460b-8027-b80775bb7d51","name":"Obter TODO o Conteúdo da Thread","type":"n8n-nodes-base.httpRequest","position":[-16,64],"typeVersion":4.2,"alwaysOutputData":true},{"parameters":{"content":"### Recuperar todo o conteúdo da thread é necessário porque a ferramenta OpenAI não recupera todas as citações na solicitação."},"id":"09446c32-59ca-4389-9cbe-76f4e099ab33","name":"Nota Adesiva 2","type":"n8n-nodes-base.stickyNote","position":[-112,-32],"typeVersion":1},{"parameters":{"fieldToSplitOut":"data","options":{}},"id":"b167addc-b7ed-40af-9463-c9653787bfb8","name":"Dividir todas as iterações de mensagens de uma thread","type":"n8n-nodes-base.splitOut","position":[-1056,288],"typeVersion":1,"alwaysOutputData":true},{"parameters":{"fieldToSplitOut":"content","options":{}},"id":"29d94b70-b536-45cb-9916-8022f29c4e19","name":"Dividir todo o conteúdo de uma única mensagem","type":"n8n-nodes-base.splitOut","position":[-816,288],"typeVersion":1,"alwaysOutputData":true},{"parameters":{"fieldToSplitOut":"text.annotations","options":{}},"id":"e7039d6e-54aa-43ea-8897-8360ca376926","name":"Dividir todas as citações de uma única mensagem","type":"n8n-nodes-base.splitOut","position":[-576,288],"typeVersion":1,"alwaysOutputData":true},{"parameters":{"url":"=https://api.openai.com/v1/files/{{ $json.file_citation.file_id }}","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendQuery":true,"queryParameters":{"parameters":[{"name":"limit","value":"1"}]},"options":{}},"id":"f5f91280-33b5-44c6-8aac-652463e2452d","name":"Recuperar nome do arquivo a partir de um ID de arquivo","type":"n8n-nodes-base.httpRequest","position":[-1056,704],"typeVersion":4.2,"alwaysOutputData":true,"onError":"continueRegularOutput"},{"parameters":{"assignments":{"assignments":[{"id":"2dcaafee-5037-4a97-942a-bcdd02bc2ad9","name":"id","type":"string","value":"={{ $json.id }}"},{"id":"b63f967d-ceea-4aa8-98b9-91f5ab21bfe8","name":"filename","type":"string","value":"={{ $json.filename }}"},{"id":"f611e749-054a-441d-8610-df8ba42de2e1","name":"text","type":"string","value":"={{ $('Split all citations from a single message').item.json.text }}"}]},"options":{}},"id":"e06adb9a-ce2b-4fda-9cc5-052bc59d5317","name":"Regularizar saída","type":"n8n-nodes-base.set","position":[-800,704],"typeVersion":3.4,"alwaysOutputData":true},{"parameters":{"content":"### Uma solicitação de recuperação de arquivo contém muitas informações, e queremos apenas o texto que será substituído e o nome do arquivo.\n\n- id\n- filename\n- text\n","height":220,"width":200},"id":"dd896b32-2d1e-449a-be52-fff0bf8af65a","name":"Nota Adesiva 3","type":"n8n-nodes-base.stickyNote","position":[-848,528],"typeVersion":1},{"parameters":{"content":"### Com as últimas três divisões, podemos ter muitas citações e textos para substituir. Ao fazer uma agregação, será possível lidar com tudo como uma única solicitação.","height":220,"width":200},"id":"5f8be0f9-a2d0-4d3a-828c-9a3b7234f298","name":"Nota Adesiva 5","type":"n8n-nodes-base.stickyNote","position":[-576,528],"typeVersion":1},{"parameters":{"content":"### Este código simples pegará todos os arquivos e citações anteriores e alterará o texto original, formatando a saída. Dessa forma, podemos usar tags Markdown para criar links, ou se preferir, podemos adicionar um nó de transformação HTML.","height":220},"id":"750146e9-258c-430b-8a49-d91b91674142","name":"Nota Adesiva 6","type":"n8n-nodes-base.stickyNote","position":[-320,528],"typeVersion":1},{"parameters":{"html":"={{ $json.output }}","destinationKey":"output","options":{}},"id":"f492c126-c12f-4348-acd0-ca5b3f75a931","name":"Opcional: Markdown para HTML","type":"n8n-nodes-base.markdown","position":[-48,704],"typeVersion":1,"disabled":true},{"parameters":{"mode":"runOnceForEachItem","jsCode":"let saida = $('OpenAI Assistant with Vector Store').item.json.output;\n\nfor (let i of $input.item.json.data) {\n saida = saida.replaceAll(i.text, \" _(\"+ i.filename+\")_ \");\n}\n\n$input.item.json.output = saida;\nreturn $input.item;"},"id":"937b463d-7106-4d0d-9273-b6cd86a48205","name":"Finalmente formatar a saída","type":"n8n-nodes-base.code","position":[-288,704],"typeVersion":2}],"connections":{"Agregar":{"main":[[{"node":"Finalmente formatar a saída","type":"main","index":0}]]},"Memória de Buffer em Janela":{"ai_memory":[[{"node":"Assistente OpenAI com Vector Store","type":"ai_memory","index":0}]]},"Criar um Trigger simples para ter o botão de Chat dentro do N8N":{"main":[[{"node":"Assistente OpenAI com Vector Store","type":"main","index":0}]]},"Assistente OpenAI com Vector Store":{"main":[[{"node":"Obter TODO o Conteúdo da Thread","type":"main","index":0}]]},"Obter TODO o Conteúdo da Thread":{"main":[[{"node":"Dividir todas as iterações de mensagens de uma thread","type":"main","index":0}]]},"Dividir todas as iterações de mensagens de uma thread":{"main":[[{"node":"Dividir todo o conteúdo de uma única mensagem","type":"main","index":0}]]},"Dividir todo o conteúdo de uma única mensagem":{"main":[[{"node":"Dividir todas as citações de uma única mensagem","type":"main","index":0}]]},"Dividir todas as citações de uma única mensagem":{"main":[[{"node":"Recuperar nome do arquivo a partir de um ID de arquivo","type":"main","index":0}]]},"Recuperar nome do arquivo a partir de um ID de arquivo":{"main":[[{"node":"Regularizar saída","type":"main","index":0}]]},"Regularizar saída":{"main":[[{"node":"Agregar","type":"main","index":0}]]},"Finalmente formatar a saída":{"main":[[{"node":"Opcional: Markdown para HTML","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"7e705dcc-2429-47a4-84ce-f8174107c2a7","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-15T14:04:41.983Z","createdAt":"2026-01-15T14:04:41.983Z","role":"workflow:owner","workflowId":"6lBo9HU83MlXLUYJ","projectId":"BlSED80HESP48veq"}],"activeVersion":null,"tags":[{"updatedAt":"2026-01-15T13:59:55.124Z","createdAt":"2026-01-15T13:59:55.124Z","id":"SEZJ3WC3B8xL71D9","name":"assist"},{"updatedAt":"2026-01-15T13:59:55.059Z","createdAt":"2026-01-15T13:59:55.059Z","id":"aGAfPGOxnJIlfwsM","name":"sample"}]}