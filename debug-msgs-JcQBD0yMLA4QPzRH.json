{"updatedAt":"2025-10-29T14:21:17.346Z","createdAt":"2025-10-29T13:26:09.788Z","id":"JcQBD0yMLA4QPzRH","name":"DEBUG MSGS","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-112,0],"id":"4f6bbb32-b1dd-4e9e-85c6-3915e3375848","name":"When clicking ‘Execute workflow’"},{"parameters":{"resource":"groups-api","operation":"fetch-groups","instanceName":"AceleradorMedico","searchMethod":"fetchAll"},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-112,224],"id":"df58bd47-0407-4375-99ab-fcac2bc2b79c","name":"Buscar grupos","credentials":{"evolutionApi":{"id":"V2fpHnZeAReBnCaU","name":"Evolution account"}}},{"parameters":{"resource":"chat-api","operation":"find-messages","instanceName":"AceleradorMedico","remoteJid":"558796250201-1616258422@g.us"},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[112,0],"id":"182b8e69-54de-4fa6-89e6-925b3dcae1c3","name":"Procurar mensagens de um contato","credentials":{"evolutionApi":{"id":"V2fpHnZeAReBnCaU","name":"Evolution account"}}},{"parameters":{"fieldToSplitOut":"data.messages.records","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[336,0],"id":"e7514961-0b1f-49c3-b310-bb6e81dc2016","name":"Split Out","alwaysOutputData":false,"executeOnce":false},{"parameters":{"jsCode":"// n8n Function: converte Unix timestamp (s ou ms) para UTC e America/Sao_Paulo\nconst TZ = 'America/Sao_Paulo';\n\nfunction toDate(ts) {\n  if (ts === undefined || ts === null || ts === '') return null;\n  let n = Number(ts);\n  if (!Number.isFinite(n)) return null;\n  // Se veio em ms, normaliza para segundos\n  if (n > 1e12) n = Math.floor(n / 1000);\n  return new Date(n * 1000);\n}\n\nreturn items.map((item) => {\n  const src =\n    item.json.messageTimestamp ??\n    item.json.message?.messageTimestamp ??\n    item.json.subjectTime ??\n    item.json.creation ??\n    item.json.timestamp ??\n    null;\n\n  const d = toDate(src);\n\n  if (!d) {\n    return {\n      json: {\n        ...item.json,\n        timestamp_parse_error: 'Timestamp ausente ou inválido',\n      },\n    };\n  }\n\n  // UTC ISO (Zulu)\n  const utc_iso = d.toISOString();\n\n  // ISO-like local (AAAA-MM-DDTHH:mm:ss) em São Paulo\n  const br_iso = new Intl.DateTimeFormat('sv-SE', {\n    timeZone: TZ,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit',\n    hour12: false,\n  })\n    .format(d)\n    .replace(' ', 'T');\n\n  // Humano pt-BR\n  const br_humano = new Intl.DateTimeFormat('pt-BR', {\n    timeZone: TZ,\n    dateStyle: 'short',\n    timeStyle: 'medium',\n  }).format(d);\n\n  return {\n    json: {\n      ...item.json,\n      messageTimestamp_sec: Math.floor(d.getTime() / 1000),\n      messageTimestamp_ms: d.getTime(),\n      timestamp_utc_iso: utc_iso,          // ex.: 2025-10-28T22:40:40.000Z\n      timestamp_brt_iso: br_iso,           // ex.: 2025-10-28T19:40:40 (sem offset)\n      timestamp_brt_humano: br_humano,     // ex.: 28/10/2025 19:40:40\n      timezone_brt: TZ,\n    },\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[544,0],"id":"06ca8e7a-dffd-442b-a5b0-19edc4531389","name":"Code in JavaScript","executeOnce":false}],"connections":{"When clicking ‘Execute workflow’":{"main":[[{"node":"Procurar mensagens de um contato","type":"main","index":0}]]},"Procurar mensagens de um contato":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"0f6b844f-e283-4c01-95a4-6a701b60f0fc","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-10-29T13:26:09.788Z","createdAt":"2025-10-29T13:26:09.788Z","role":"workflow:owner","workflowId":"JcQBD0yMLA4QPzRH","projectId":"BlSED80HESP48veq"}],"activeVersion":null,"tags":[]}