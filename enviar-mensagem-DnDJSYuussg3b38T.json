{"updatedAt":"2025-10-17T01:09:39.343Z","createdAt":"2025-10-07T18:17:24.064Z","id":"DnDJSYuussg3b38T","name":"Enviar Mensagem","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"6448debf-f51c-45f3-9bde-f29b3db624c4","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-48,16],"id":"c32b2e83-8d57-46db-805e-183d50a07c76","name":"Webhook","webhookId":"6448debf-f51c-45f3-9bde-f29b3db624c4"},{"parameters":{"content":"#### a automação vai identificar se é horario correto para enviar. Se sim, deve verificar se ja foi enviado nas ultimas 10  horas para este contato.","height":96,"width":1120,"color":4},"type":"n8n-nodes-base.stickyNote","position":[640,-208],"typeVersion":1,"id":"62306b4c-97e5-4039-959d-e1a9bb615a58","name":"Sticky Note"},{"parameters":{"assignments":{"assignments":[{"id":"d0be8cb0-e4b4-41dd-beb1-ab57a5a4d394","name":"contato","value":"={{ $json.body.data.key.remoteJid }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[400,112],"id":"03e08cf8-a8ee-4df2-8715-87af44146b3c","name":"remoteJid"},{"parameters":{"assignments":{"assignments":[{"id":"d0be8cb0-e4b4-41dd-beb1-ab57a5a4d394","name":"contato","value":"={{ $json.body.data.key.senderPn }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[400,-80],"id":"87d8755f-cd4c-4b3e-a4db-46cef83f9eeb","name":"senderPn"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c934af8a-7940-4631-b60a-af7a960a5d39","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"@lid","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[176,16],"id":"5bd938eb-36b3-4ffa-95ad-7f5fd537b61a","name":"Se @lid privado"},{"parameters":{"jsCode":"/**\n * Bloqueia envio se: (a) estamos na janela de silêncio OU é fim de semana\n * e (b) houve mensagem há < 10h.\n */\n\nconst TZ = 'America/Sao_Paulo';\nconst OFFSET = '-03:00';                 // fuso do timestamp do banco\nconst LOOKBACK_MS = 10 * 60 * 60 * 1000; // 10h\n\n// 1) Horários (puxa do nó de config; fallback no item atual)\nconst cfg = $items('Verifica Horario - Configuração', 0, 0)?.json\n         ?? $items('Configuração', 0, 0)?.json\n         ?? {};\nconst hora_inicio = cfg.hora_inicio ?? $json.hora_inicio ?? '18:45';\nconst hora_fim    = cfg.hora_fim    ?? $json.hora_fim    ?? '08:00';\n\n// 2) Última mensagem do SELECT (ex.: \"2025-10-07 16:45:10\")\nconst ultimaMensagem = $('Ver se mensagem ja foi enviada').last().json.datatime;\n\n// ---- helpers ----\nfunction parseToMinutes(v) {\n  const [h, m = '0'] = String(v).trim().replace(/h/i, ':').split(':');\n  const H = Math.max(0, Math.min(23, parseInt(h,10) || 0));\n  const M = Math.max(0, Math.min(59, parseInt(m,10) || 0));\n  return H * 60 + M;\n}\n\nfunction nowInTZ(timeZone) {\n  const f = new Intl.DateTimeFormat('en-CA', {\n    timeZone, hour12: false,\n    year:'numeric', month:'2-digit', day:'2-digit',\n    hour:'2-digit', minute:'2-digit'\n  });\n  const p = Object.fromEntries(f.formatToParts(new Date()).map(x => [x.type, x.value]));\n  const hhmm = `${p.hour}:${p.minute}`;\n  const day = new Date(`${p.year}-${p.month}-${p.day}T${hhmm}:00`).getDay(); // 0=Dom\n  const minutes = parseInt(p.hour,10)*60 + parseInt(p.minute,10);\n  return { hhmm, day, minutes };\n}\n\n// Normaliza \"YYYY-MM-DD HH:mm:ss\" -> ISO com offset (ex.: -03:00)\nfunction parseDbDateTime(str, offset) {\n  if (!str) return null;\n  const s = String(str).trim();\n  let iso;\n\n  if (/^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}(:\\d{2})?$/.test(s)) {\n    const [d, t] = s.split(' ');\n    const t2 = t.length === 5 ? `${t}:00` : t;\n    iso = `${d}T${t2}${offset}`;\n  } else if (/Z|[+\\-]\\d{2}:\\d{2}$/.test(s)) {\n    iso = s; // já tem timezone\n  } else if (s.includes('T')) {\n    iso = s + offset;\n  } else {\n    iso = s.replace(' ', 'T') + offset;\n  }\n\n  const date = new Date(iso);\n  return Number.isNaN(date.getTime()) ? null : date;\n}\n\n// ---- janela de silêncio ----\nconst start = parseToMinutes(hora_inicio);\nconst end   = parseToMinutes(hora_fim);\nconst now   = nowInTZ(TZ);\nconst isWeekend = (now.day === 0 || now.day === 6);\n\nconst dentroSilencio = (start <= end)\n  ? (now.minutes >= start && now.minutes < end)\n  : (now.minutes >= start || now.minutes < end);\n\nconst foraHorario = isWeekend || dentroSilencio;\n\n// ---- última < 10h? ----\nconst ultima = parseDbDateTime(ultimaMensagem, OFFSET);\nconst diffMs = ultima ? (Date.now() - ultima.getTime()) : null;\nconst dentroDas10h = diffMs !== null ? (diffMs < LOOKBACK_MS) : false;\n\n// ---- decisão ----\nlet deveEnviar = true;\nlet motivo = 'foraDoSilencio';\n\nif (foraHorario && dentroDas10h) {\n  deveEnviar = false;\n  motivo = 'mensagemRecente';\n} else if (!foraHorario) {\n  motivo = 'horarioComercial';\n}\n\nreturn [{\n  json: {\n    deveEnviar,\n    foraHorario,\n    dentroDas10h,\n    diffMin: diffMs !== null ? Math.floor(diffMs/60000) : null,\n    horaAtual: now.hhmm,\n    ultimaMensagem,\n    ultimaISO: ultima ? ultima.toISOString() : null,\n    janela: { inicio: hora_inicio, fim: hora_fim },\n    isWeekend\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1744,16],"id":"ad742c2b-0014-4b77-ad59-5f6bc11bfa55","name":"Verifica se ja foi enviado"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"935cb00f-7c37-4b8c-b7ba-66598c30b785","leftValue":"={{ $json.deveEnviar }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"8c4e418e-1d7b-434d-817b-5f61969cd531","leftValue":"={{ $('Verifica Horario - Configuração').item.json.foraHorario }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"2fb98363-3250-4548-b49c-b88921f676a8","leftValue":"={{ $json.dentroDas10h }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1968,16],"id":"138e5ae6-ad7b-4aee-8ddd-3c42709a3f8a","name":"Se nao enviado"},{"parameters":{"method":"POST","url":"=https://evolutionapi-evolutionapi.ac69mn.easypanel.host/message/SendText/Juridico06","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=5C18602C94B9-4448-B83D-E182EF0DD973"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('Contato').last().json.contato }}"},{"name":"text","value":"=Olá! Obrigado por entrar em contato com a C&D Blindagem Digital.\n\nNossa equipe  está disponível de *segunda a sexta, das 8h às 18h.* \nNo primeiro horário do próximo dia útil responderemos."}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2336,-80],"id":"1edd9de3-3314-40a9-9dd7-72707b14eac3","name":"Enviando Transcrição1"},{"parameters":{"assignments":{"assignments":[{"id":"0542100a-82a6-45f6-8905-ab54b1934cde","name":"hora_inicio","value":"18:00","type":"string"},{"id":"536f2b4a-b967-4cad-9325-c7985c6b9dff","name":"hora_fim","value":"08:00","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1296,16],"id":"f8fde114-a2c9-48a6-af32-ee8890ba1c0c","name":"Configuração"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3f746385-7547-4c3f-82b6-99ba3820a755","leftValue":"={{ $json.contato }}","rightValue":"556294342576@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[848,16],"id":"34f9f781-5273-48d4-8843-1f79d3969aa0","name":"If","disabled":true},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM `msg_fora_hora`\n  WHERE `contato` = '{{ $('Webhook').item.json.body.data.key.senderPn }}';","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[1072,16],"id":"49669aaa-59a9-4d46-a4ac-bd3100655172","name":"Ver se mensagem ja foi enviada","alwaysOutputData":true,"credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"jsCode":"/**\n * Lê hora_inicio e hora_fim (string: \"HH\" ou \"HH:mm\") e retorna:\n *  - foraHorario: true se FORA do horário comercial (na janela de silêncio)\n *  - suporta janela que cruza a meia-noite (ex.: 18:45 -> 08:00)\n *  - considera fim de semana como fora do comercial (ajuste WEEKEND_IS_OFF)\n */\n\nconst { hora_inicio = '$input.first().json.hora_inicio', hora_fim = '$input.first().json.hora_fim' } = $json;\n\n// CONFIG\nconst TZ = 'America/Sao_Paulo';\nconst WEEKEND_IS_OFF = true;\n\n// Helpers\nfunction parseToMinutes(v) {\n  if (typeof v !== 'string') v = String(v ?? '');\n  v = v.replace(/\\s+/g, '').replace(/h/i, ':'); // aceita \"18h45\"\n  const [hStr, mStr] = v.split(':');\n  const h = Math.min(23, Math.max(0, parseInt(hStr, 10) || 0));\n  const m = Math.min(59, Math.max(0, parseInt(mStr ?? '0', 10) || 0));\n  return h * 60 + m;\n}\n\nfunction nowInTZ(timeZone) {\n  const fmt = new Intl.DateTimeFormat('en-CA', {\n    timeZone, hour12: false,\n    year: 'numeric', month: '2-digit', day: '2-digit',\n    hour: '2-digit', minute: '2-digit'\n  });\n  const parts = Object.fromEntries(fmt.formatToParts(new Date()).map(p => [p.type, p.value]));\n  const hhmm = `${parts.hour}:${parts.minute}`;\n  const day = new Date(`${parts.year}-${parts.month}-${parts.day}T${hhmm}:00`).getDay(); // 0=Dom\n  const minutes = parseInt(parts.hour, 10) * 60 + parseInt(parts.minute, 10);\n  return { hhmm, day, minutes };\n}\n\n// Core\nconst startMin = parseToMinutes(hora_inicio); // início do silêncio\nconst endMin   = parseToMinutes(hora_fim);    // fim do silêncio\nconst now = nowInTZ(TZ);\n\nconst isWeekend = WEEKEND_IS_OFF && (now.day === 0 || now.day === 6);\n\n// janela pode cruzar a meia-noite\nconst dentroJanelaSilencio = (startMin <= endMin)\n  ? (now.minutes >= startMin && now.minutes < endMin)\n  : (now.minutes >= startMin || now.minutes < endMin);\n\nconst foraHorario = isWeekend || dentroJanelaSilencio;\n\nreturn [\n  {\n    json: {\n      foraHorario,                         // true = fora do comercial\n      motivo: isWeekend ? 'fimDeSemana' : (dentroJanelaSilencio ? 'janelaSilencio' : 'horarioComercial'),\n      horaAtual: now.hhmm,\n      inicioSilencio: String(hora_inicio),\n      fimSilencio: String(hora_fim),\n      isWeekend\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1520,16],"id":"53667c0e-b420-4683-a8a1-7c4030b9ff7b","name":"Verifica Horario - Configuração"},{"parameters":{"assignments":{"assignments":[{"id":"0c39250b-0898-44a8-be51-517cb42b837d","name":"contato","value":"={{ $json.contato }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[624,16],"id":"85ee1c8a-c94c-436c-aea4-6729e1fe6d6a","name":"Contato"},{"parameters":{"table":{"__rl":true,"value":"msg_fora_hora","mode":"list","cachedResultName":"msg_fora_hora"},"dataMode":"defineBelow","valuesToSend":{"values":[{"column":"contato","value":"={{ $('Contato').last().json.contato }}"},{"column":"datatime","value":"={{ $now }}"}]},"options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[2560,-80],"id":"46a60180-f1e9-4d65-91e4-3fd2a73bb26f","name":"Insert rows in a table","credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"method":"POST","url":"=https://evolutionapi-evolutionapi.ac69mn.easypanel.host/message/SendText/notificacoes","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=o43h6kACBsSlJiiUCbTkdMXrj9FYEe0c"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"=556294342576@s.whatsapp.net"},{"name":"text","value":"=Mensagem de fora de hora enviada ao cliente: {{ $('Webhook').last().json.body.data.pushName }} - {{ $('Contato').last().json.contato }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2336,112],"id":"d77f8758-8996-4b2c-a161-693cfa0e4cb0","name":"Enviando Transcrição"}],"connections":{"Webhook":{"main":[[{"node":"Se @lid privado","type":"main","index":0}]]},"Se @lid privado":{"main":[[{"node":"senderPn","type":"main","index":0}],[{"node":"remoteJid","type":"main","index":0}]]},"senderPn":{"main":[[{"node":"Contato","type":"main","index":0}]]},"remoteJid":{"main":[[{"node":"Contato","type":"main","index":0}]]},"Verifica se ja foi enviado":{"main":[[{"node":"Se nao enviado","type":"main","index":0}]]},"Se nao enviado":{"main":[[{"node":"Enviando Transcrição1","type":"main","index":0},{"node":"Enviando Transcrição","type":"main","index":0}],[]]},"Configuração":{"main":[[{"node":"Verifica Horario - Configuração","type":"main","index":0}]]},"If":{"main":[[{"node":"Ver se mensagem ja foi enviada","type":"main","index":0}]]},"Ver se mensagem ja foi enviada":{"main":[[{"node":"Configuração","type":"main","index":0}]]},"Verifica Horario - Configuração":{"main":[[{"node":"Verifica se ja foi enviado","type":"main","index":0}]]},"Contato":{"main":[[{"node":"If","type":"main","index":0}]]},"Enviando Transcrição1":{"main":[[{"node":"Insert rows in a table","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Sao_Paulo","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"primary-production-70c40.up.railway.app","user-agent":"axios/1.8.3","content-length":"1760","accept":"application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"162.220.232.13","x-forwarded-host":"primary-production-70c40.up.railway.app","x-forwarded-proto":"https","x-railway-edge":"railway/us-west2","x-railway-request-id":"pWokjhLaQv-W9U6Sn6XIxQ","x-real-ip":"162.220.232.13","x-request-start":"1760652502323"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"Juridico06","data":{"key":{"remoteJid":"555496971224@s.whatsapp.net","remoteJidAlt":"151655328809068:26@lid","fromMe":true,"id":"3EB07B1E4668921B07FA7D"},"pushName":"C&D Blindagem Digital | Camozzi Consultoria","status":"SERVER_ACK","message":{"conversation":"*[C&D Resolve - Thais Nascimento]*\n\nBoa noite! Tudo bem?\n\nReferente aos contratos enviados para alteração mediante termo aditivo, realizamos a análise de ambos os documentos e nossa recomendação é que, em vez de elaborar termos aditivos aos contratos existentes, seja feito o distrato e, posteriormente, novos contratos para as duas prestadoras.\n\nO modelo atualmente utilizado não contempla previsões importantes que constam no nosso modelo de contrato, além de os contratos originais serem de 2024, estando, portanto, vencidos.\n\nSugerimos seguir dessa forma (distrato e novo contrato) para garantir maior segurança jurídica e atualização das condições contratuais.\nPedimos, por gentileza, que nos confirme se podemos prosseguir com essa adequação — assim, enviaremos os documentos até amanhã.\n\nAtenciosamente,\nC&D Blindagem Digital"},"contextInfo":{"mentionedJid":[],"groupMentions":[],"ephemeralSettingTimestamp":1760447901,"disappearingMode":{"initiator":0,"trigger":1,"initiatedByMe":false}},"messageType":"conversation","messageTimestamp":1760652500,"instanceId":"f194308b-f702-4e4b-92a5-8afe1f609d9c","source":"web"},"destination":"https://primary-production-70c40.up.railway.app/webhook/86351806-11bc-468d-84dd-fcf535477df5","date_time":"2025-10-16T19:08:22.051Z","sender":"556293474664@s.whatsapp.net","server_url":"https://evolutionapi-evolutionapi.ac69mn.easypanel.host","apikey":"5C18602C94B9-4448-B83D-E182EF0DD973"},"webhookUrl":"https://primary-production-70c40.up.railway.app/webhook/6448debf-f51c-45f3-9bde-f29b3db624c4","executionMode":"production"}}]},"versionId":"5b407ad1-1703-4f96-a8eb-3d96af45ed3a","activeVersionId":"5b407ad1-1703-4f96-a8eb-3d96af45ed3a","triggerCount":1,"shared":[{"updatedAt":"2025-10-07T18:17:24.064Z","createdAt":"2025-10-07T18:17:24.064Z","role":"workflow:owner","workflowId":"DnDJSYuussg3b38T","projectId":"BlSED80HESP48veq"}],"activeVersion":{"updatedAt":"2025-12-01T11:56:54.083Z","createdAt":"2025-12-01T11:56:54.083Z","versionId":"5b407ad1-1703-4f96-a8eb-3d96af45ed3a","workflowId":"DnDJSYuussg3b38T","nodes":[{"parameters":{"httpMethod":"POST","path":"6448debf-f51c-45f3-9bde-f29b3db624c4","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-48,16],"id":"c32b2e83-8d57-46db-805e-183d50a07c76","name":"Webhook","webhookId":"6448debf-f51c-45f3-9bde-f29b3db624c4"},{"parameters":{"content":"#### a automação vai identificar se é horario correto para enviar. Se sim, deve verificar se ja foi enviado nas ultimas 10  horas para este contato.","height":96,"width":1120,"color":4},"type":"n8n-nodes-base.stickyNote","position":[640,-208],"typeVersion":1,"id":"62306b4c-97e5-4039-959d-e1a9bb615a58","name":"Sticky Note"},{"parameters":{"assignments":{"assignments":[{"id":"d0be8cb0-e4b4-41dd-beb1-ab57a5a4d394","name":"contato","value":"={{ $json.body.data.key.remoteJid }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[400,112],"id":"03e08cf8-a8ee-4df2-8715-87af44146b3c","name":"remoteJid"},{"parameters":{"assignments":{"assignments":[{"id":"d0be8cb0-e4b4-41dd-beb1-ab57a5a4d394","name":"contato","value":"={{ $json.body.data.key.senderPn }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[400,-80],"id":"87d8755f-cd4c-4b3e-a4db-46cef83f9eeb","name":"senderPn"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c934af8a-7940-4631-b60a-af7a960a5d39","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"@lid","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[176,16],"id":"5bd938eb-36b3-4ffa-95ad-7f5fd537b61a","name":"Se @lid privado"},{"parameters":{"jsCode":"/**\n * Bloqueia envio se: (a) estamos na janela de silêncio OU é fim de semana\n * e (b) houve mensagem há < 10h.\n */\n\nconst TZ = 'America/Sao_Paulo';\nconst OFFSET = '-03:00';                 // fuso do timestamp do banco\nconst LOOKBACK_MS = 10 * 60 * 60 * 1000; // 10h\n\n// 1) Horários (puxa do nó de config; fallback no item atual)\nconst cfg = $items('Verifica Horario - Configuração', 0, 0)?.json\n         ?? $items('Configuração', 0, 0)?.json\n         ?? {};\nconst hora_inicio = cfg.hora_inicio ?? $json.hora_inicio ?? '18:45';\nconst hora_fim    = cfg.hora_fim    ?? $json.hora_fim    ?? '08:00';\n\n// 2) Última mensagem do SELECT (ex.: \"2025-10-07 16:45:10\")\nconst ultimaMensagem = $('Ver se mensagem ja foi enviada').last().json.datatime;\n\n// ---- helpers ----\nfunction parseToMinutes(v) {\n  const [h, m = '0'] = String(v).trim().replace(/h/i, ':').split(':');\n  const H = Math.max(0, Math.min(23, parseInt(h,10) || 0));\n  const M = Math.max(0, Math.min(59, parseInt(m,10) || 0));\n  return H * 60 + M;\n}\n\nfunction nowInTZ(timeZone) {\n  const f = new Intl.DateTimeFormat('en-CA', {\n    timeZone, hour12: false,\n    year:'numeric', month:'2-digit', day:'2-digit',\n    hour:'2-digit', minute:'2-digit'\n  });\n  const p = Object.fromEntries(f.formatToParts(new Date()).map(x => [x.type, x.value]));\n  const hhmm = `${p.hour}:${p.minute}`;\n  const day = new Date(`${p.year}-${p.month}-${p.day}T${hhmm}:00`).getDay(); // 0=Dom\n  const minutes = parseInt(p.hour,10)*60 + parseInt(p.minute,10);\n  return { hhmm, day, minutes };\n}\n\n// Normaliza \"YYYY-MM-DD HH:mm:ss\" -> ISO com offset (ex.: -03:00)\nfunction parseDbDateTime(str, offset) {\n  if (!str) return null;\n  const s = String(str).trim();\n  let iso;\n\n  if (/^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}(:\\d{2})?$/.test(s)) {\n    const [d, t] = s.split(' ');\n    const t2 = t.length === 5 ? `${t}:00` : t;\n    iso = `${d}T${t2}${offset}`;\n  } else if (/Z|[+\\-]\\d{2}:\\d{2}$/.test(s)) {\n    iso = s; // já tem timezone\n  } else if (s.includes('T')) {\n    iso = s + offset;\n  } else {\n    iso = s.replace(' ', 'T') + offset;\n  }\n\n  const date = new Date(iso);\n  return Number.isNaN(date.getTime()) ? null : date;\n}\n\n// ---- janela de silêncio ----\nconst start = parseToMinutes(hora_inicio);\nconst end   = parseToMinutes(hora_fim);\nconst now   = nowInTZ(TZ);\nconst isWeekend = (now.day === 0 || now.day === 6);\n\nconst dentroSilencio = (start <= end)\n  ? (now.minutes >= start && now.minutes < end)\n  : (now.minutes >= start || now.minutes < end);\n\nconst foraHorario = isWeekend || dentroSilencio;\n\n// ---- última < 10h? ----\nconst ultima = parseDbDateTime(ultimaMensagem, OFFSET);\nconst diffMs = ultima ? (Date.now() - ultima.getTime()) : null;\nconst dentroDas10h = diffMs !== null ? (diffMs < LOOKBACK_MS) : false;\n\n// ---- decisão ----\nlet deveEnviar = true;\nlet motivo = 'foraDoSilencio';\n\nif (foraHorario && dentroDas10h) {\n  deveEnviar = false;\n  motivo = 'mensagemRecente';\n} else if (!foraHorario) {\n  motivo = 'horarioComercial';\n}\n\nreturn [{\n  json: {\n    deveEnviar,\n    foraHorario,\n    dentroDas10h,\n    diffMin: diffMs !== null ? Math.floor(diffMs/60000) : null,\n    horaAtual: now.hhmm,\n    ultimaMensagem,\n    ultimaISO: ultima ? ultima.toISOString() : null,\n    janela: { inicio: hora_inicio, fim: hora_fim },\n    isWeekend\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1744,16],"id":"ad742c2b-0014-4b77-ad59-5f6bc11bfa55","name":"Verifica se ja foi enviado"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"935cb00f-7c37-4b8c-b7ba-66598c30b785","leftValue":"={{ $json.deveEnviar }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"8c4e418e-1d7b-434d-817b-5f61969cd531","leftValue":"={{ $('Verifica Horario - Configuração').item.json.foraHorario }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"2fb98363-3250-4548-b49c-b88921f676a8","leftValue":"={{ $json.dentroDas10h }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1968,16],"id":"138e5ae6-ad7b-4aee-8ddd-3c42709a3f8a","name":"Se nao enviado"},{"parameters":{"method":"POST","url":"=https://evolutionapi-evolutionapi.ac69mn.easypanel.host/message/SendText/Juridico06","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=5C18602C94B9-4448-B83D-E182EF0DD973"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('Contato').last().json.contato }}"},{"name":"text","value":"=Olá! Obrigado por entrar em contato com a C&D Blindagem Digital.\n\nNossa equipe  está disponível de *segunda a sexta, das 8h às 18h.* \nNo primeiro horário do próximo dia útil responderemos."}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2336,-80],"id":"1edd9de3-3314-40a9-9dd7-72707b14eac3","name":"Enviando Transcrição1"},{"parameters":{"assignments":{"assignments":[{"id":"0542100a-82a6-45f6-8905-ab54b1934cde","name":"hora_inicio","value":"18:00","type":"string"},{"id":"536f2b4a-b967-4cad-9325-c7985c6b9dff","name":"hora_fim","value":"08:00","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1296,16],"id":"f8fde114-a2c9-48a6-af32-ee8890ba1c0c","name":"Configuração"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3f746385-7547-4c3f-82b6-99ba3820a755","leftValue":"={{ $json.contato }}","rightValue":"556294342576@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[848,16],"id":"34f9f781-5273-48d4-8843-1f79d3969aa0","name":"If","disabled":true},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM `msg_fora_hora`\n  WHERE `contato` = '{{ $('Webhook').item.json.body.data.key.senderPn }}';","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[1072,16],"id":"49669aaa-59a9-4d46-a4ac-bd3100655172","name":"Ver se mensagem ja foi enviada","alwaysOutputData":true,"credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"jsCode":"/**\n * Lê hora_inicio e hora_fim (string: \"HH\" ou \"HH:mm\") e retorna:\n *  - foraHorario: true se FORA do horário comercial (na janela de silêncio)\n *  - suporta janela que cruza a meia-noite (ex.: 18:45 -> 08:00)\n *  - considera fim de semana como fora do comercial (ajuste WEEKEND_IS_OFF)\n */\n\nconst { hora_inicio = '$input.first().json.hora_inicio', hora_fim = '$input.first().json.hora_fim' } = $json;\n\n// CONFIG\nconst TZ = 'America/Sao_Paulo';\nconst WEEKEND_IS_OFF = true;\n\n// Helpers\nfunction parseToMinutes(v) {\n  if (typeof v !== 'string') v = String(v ?? '');\n  v = v.replace(/\\s+/g, '').replace(/h/i, ':'); // aceita \"18h45\"\n  const [hStr, mStr] = v.split(':');\n  const h = Math.min(23, Math.max(0, parseInt(hStr, 10) || 0));\n  const m = Math.min(59, Math.max(0, parseInt(mStr ?? '0', 10) || 0));\n  return h * 60 + m;\n}\n\nfunction nowInTZ(timeZone) {\n  const fmt = new Intl.DateTimeFormat('en-CA', {\n    timeZone, hour12: false,\n    year: 'numeric', month: '2-digit', day: '2-digit',\n    hour: '2-digit', minute: '2-digit'\n  });\n  const parts = Object.fromEntries(fmt.formatToParts(new Date()).map(p => [p.type, p.value]));\n  const hhmm = `${parts.hour}:${parts.minute}`;\n  const day = new Date(`${parts.year}-${parts.month}-${parts.day}T${hhmm}:00`).getDay(); // 0=Dom\n  const minutes = parseInt(parts.hour, 10) * 60 + parseInt(parts.minute, 10);\n  return { hhmm, day, minutes };\n}\n\n// Core\nconst startMin = parseToMinutes(hora_inicio); // início do silêncio\nconst endMin   = parseToMinutes(hora_fim);    // fim do silêncio\nconst now = nowInTZ(TZ);\n\nconst isWeekend = WEEKEND_IS_OFF && (now.day === 0 || now.day === 6);\n\n// janela pode cruzar a meia-noite\nconst dentroJanelaSilencio = (startMin <= endMin)\n  ? (now.minutes >= startMin && now.minutes < endMin)\n  : (now.minutes >= startMin || now.minutes < endMin);\n\nconst foraHorario = isWeekend || dentroJanelaSilencio;\n\nreturn [\n  {\n    json: {\n      foraHorario,                         // true = fora do comercial\n      motivo: isWeekend ? 'fimDeSemana' : (dentroJanelaSilencio ? 'janelaSilencio' : 'horarioComercial'),\n      horaAtual: now.hhmm,\n      inicioSilencio: String(hora_inicio),\n      fimSilencio: String(hora_fim),\n      isWeekend\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1520,16],"id":"53667c0e-b420-4683-a8a1-7c4030b9ff7b","name":"Verifica Horario - Configuração"},{"parameters":{"assignments":{"assignments":[{"id":"0c39250b-0898-44a8-be51-517cb42b837d","name":"contato","value":"={{ $json.contato }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[624,16],"id":"85ee1c8a-c94c-436c-aea4-6729e1fe6d6a","name":"Contato"},{"parameters":{"table":{"__rl":true,"value":"msg_fora_hora","mode":"list","cachedResultName":"msg_fora_hora"},"dataMode":"defineBelow","valuesToSend":{"values":[{"column":"contato","value":"={{ $('Contato').last().json.contato }}"},{"column":"datatime","value":"={{ $now }}"}]},"options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[2560,-80],"id":"46a60180-f1e9-4d65-91e4-3fd2a73bb26f","name":"Insert rows in a table","credentials":{"mySql":{"id":"JGOB8ullb4MxT7Do","name":"operacional-consultoria"}}},{"parameters":{"method":"POST","url":"=https://evolutionapi-evolutionapi.ac69mn.easypanel.host/message/SendText/notificacoes","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=o43h6kACBsSlJiiUCbTkdMXrj9FYEe0c"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"=556294342576@s.whatsapp.net"},{"name":"text","value":"=Mensagem de fora de hora enviada ao cliente: {{ $('Webhook').last().json.body.data.pushName }} - {{ $('Contato').last().json.contato }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2336,112],"id":"d77f8758-8996-4b2c-a161-693cfa0e4cb0","name":"Enviando Transcrição"}],"connections":{"Webhook":{"main":[[{"node":"Se @lid privado","type":"main","index":0}]]},"Se @lid privado":{"main":[[{"node":"senderPn","type":"main","index":0}],[{"node":"remoteJid","type":"main","index":0}]]},"senderPn":{"main":[[{"node":"Contato","type":"main","index":0}]]},"remoteJid":{"main":[[{"node":"Contato","type":"main","index":0}]]},"Verifica se ja foi enviado":{"main":[[{"node":"Se nao enviado","type":"main","index":0}]]},"Se nao enviado":{"main":[[{"node":"Enviando Transcrição1","type":"main","index":0},{"node":"Enviando Transcrição","type":"main","index":0}],[]]},"Configuração":{"main":[[{"node":"Verifica Horario - Configuração","type":"main","index":0}]]},"If":{"main":[[{"node":"Ver se mensagem ja foi enviada","type":"main","index":0}]]},"Ver se mensagem ja foi enviada":{"main":[[{"node":"Configuração","type":"main","index":0}]]},"Verifica Horario - Configuração":{"main":[[{"node":"Verifica se ja foi enviado","type":"main","index":0}]]},"Contato":{"main":[[{"node":"If","type":"main","index":0}]]},"Enviando Transcrição1":{"main":[[{"node":"Insert rows in a table","type":"main","index":0}]]}},"authors":"system migration","name":null,"description":null},"tags":[]}