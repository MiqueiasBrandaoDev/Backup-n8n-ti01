{"updatedAt":"2025-09-22T15:56:20.341Z","createdAt":"2025-09-17T15:38:28.438Z","id":"2e6P9Gvq0kE1jxBp","name":"Gerador Tasks - Clickmax","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"triggerAtHour":8},{"triggerAtHour":20}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-976,-624],"id":"4e2ad0e0-3be8-441e-9510-36139d161173","name":"Schedule Trigger"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.Hour }}","rightValue":"8","operator":{"type":"string","operation":"equals"},"id":"5ffb2d7c-de7d-4707-915b-1f10f58daa18"}],"combinator":"and"},"renameOutput":true,"outputKey":"8hrs"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b763d0e7-f6c9-4a4b-9692-aedea9a140a3","leftValue":"={{ $json.Hour }}","rightValue":"20","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"20hrs"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-752,-640],"id":"9bac970a-bb13-498d-927c-2245a6dc5f56","name":"Switch"},{"parameters":{"jsCode":"// Input: items (cada item.json Ã© uma linha do SELECT)\n// Output: 1 item por grupo_id com as mensagens desse grupo\n\nconst rows = items.map(i => i.json);\n\n// Agrupa por grupo_id\nconst groups = new Map();\nfor (const r of rows) {\n  const g = r.grupo_id;\n  if (!groups.has(g)) groups.set(g, []);\n  groups.get(g).push(r);\n}\n\n// Ordena dentro de cada grupo por data_mensagem (asc)\nfor (const arr of groups.values()) {\n  arr.sort((a, b) => new Date(a.data_mensagem) - new Date(b.data_mensagem));\n}\n\n// Retorna 1 item por grupo\nconst out = [];\nfor (const [grupo_id, messages] of groups.entries()) {\n  out.push({\n    json: {\n      grupo_id,\n      count: messages.length,\n      messages, // array de linhas originais\n    },\n  });\n}\n\nreturn out;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-304,-624],"id":"4502b190-4cdd-4fd7-ad96-e874484c641c","name":"Code"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-80,-624],"id":"7fbe0d21-23ac-484c-89f5-58d9d7903d79","name":"Loop Over Items1"},{"parameters":{"workflowId":{"__rl":true,"value":"fRWOhxBwGoWNup0q","mode":"list","cachedResultName":"SubFlow - Tasks Bilhon"},"workflowInputs":{"mappingMode":"defineBelow","value":{"msgs":"={{ $('Loop Over Items1').item.json.messages }}","grupo_id":"={{ $json.grupo_id.replace('-bilhon', '') }}"},"matchingColumns":[],"schema":[{"id":"grupo_id","displayName":"grupo_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"msgs","displayName":"msgs","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"array","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[144,-624],"name":"Call SubFlow - Tasks Bilhon","id":"55832b38-5b14-4b57-9cc4-53f21cb10f67","alwaysOutputData":true,"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nFROM `mensagens`\nWHERE grupo_id LIKE '%-bilhon'\n  AND data_mensagem >= '{{ $now.minus({ days: 1 }).toFormat(\"yyyy-MM-dd\") }} 00:00:00'\n  AND data_mensagem < '{{ $now.toFormat(\"yyyy-MM-dd\") }} 00:00:00';","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[-528,-720],"id":"803da4ae-900f-4e04-ad6d-466e6e5088a0","name":"Dia anterior","credentials":{"mySql":{"id":"baCaDIho0XdcR8ql","name":"MySQL account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT *\nFROM `mensagens`\nWHERE grupo_id LIKE '%-bilhon'\n  AND data_mensagem >= '{{ $now.toFormat(\"yyyy-MM-dd\") }} 00:00:00'\n  AND data_mensagem < '{{ $now.plus({ days: 1 }).toFormat(\"yyyy-MM-dd\") }} 00:00:00';","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[-528,-528],"id":"156c1675-05b2-4411-9501-504633cc801c","name":"Dia Atual","credentials":{"mySql":{"id":"baCaDIho0XdcR8ql","name":"MySQL account"}}}],"connections":{"Schedule Trigger":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Dia anterior","type":"main","index":0}],[{"node":"Dia Atual","type":"main","index":0}],[{"node":"Dia anterior","type":"main","index":0}]]},"Code":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Call SubFlow - Tasks Bilhon","type":"main","index":0}]]},"Call SubFlow - Tasks Bilhon":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Dia anterior":{"main":[[{"node":"Code","type":"main","index":0}]]},"Dia Atual":{"main":[[{"node":"Code","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Sao_Paulo","callerPolicy":"workflowsFromSameOwner"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"d38aa5e3-42c6-4dc4-afa5-9207248ca916","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-09-17T15:38:28.438Z","createdAt":"2025-09-17T15:38:28.438Z","role":"workflow:owner","workflowId":"2e6P9Gvq0kE1jxBp","projectId":"BlSED80HESP48veq"}],"activeVersion":null,"tags":[]}